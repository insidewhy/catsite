<polymer-element name="catsite-status" attributes="switches">
  <template>
    <template repeat="{{switch in switches}}">
      <div class="switch">
        <div class="switch-name">{{switch.name}}</div>
        <paper-toggle-button data-switch={{switch.name}} on-change={{buttonChange}}></paper-toggle-button>
        <div class="switch-status">{{switch.status}}</div>
      </div>
    </template>
  </template>
  <style shim-shadowdom>
    catsite-app /deep/ .switch {
      clear: left;
      height: 35px;
      line-height: 35px;
    }
    catsite-app /deep/ .switch-name {
      width: 6em;
      float: left;
    }
    catsite-app /deep/ .switch-status {
      float: left;
      margin-left: 10px;
      font-size: 80%;
      color: #aaaaaa;
    }
    catsite-app /deep/ paper-toggle-button {
      float: left;
      margin-top: 11px;
    }
  </style>
  <script>
    Polymer({
      buttonChange: function(event, detail, sender) {
        var name = sender.attributes['data-switch'].value
        var swtch = _.find(this.switches, 'name', name)
        var status = swtch.status = sender.checked ? 'on' : 'off'

        var xhr = new XMLHttpRequest
        xhr.open('POST', '/' + status + '/' + swtch.name)
        xhr.onload = function(e) {
          console.log('switched!')
        }
        xhr.onerror = function(e) {
          console.log('failed to switch :(')
        }
        xhr.send()
      }
    })
  </script>
</polymer-element>

<polymer-element name="catsite-app">
  <template>
    <core-ajax auto url=/status handleAs=json on-core-response="{{onStatus}}"></core-ajax>
    <core-header-panel>
      <core-toolbar>
        <paper-tabs id=tabs selected="{{selected}}" self-end>
          <paper-tab name=status>Current Status</paper-tab>
          <paper-tab name=calendar>Power Switch Calendar</paper-tab>
        </paper-tabs>
      </core-toolbar>
      <core-pages selected="{{selected}}">
        <catsite-status name=status switches="{{switches}}">
        </catsite-status>
        <div name=calendar>Calendar page</div>
      </core-pages>
      <!-- main page content will go here -->
    </core-header-panel>
  </template>
  <style shim-shadowdom>
    html,body {
      height: 100%;
      margin: 0;
      font-family: 'RobotoDraft', sans-serif;
    }
    catsite-app::shadow core-header-panel {
      height: 100%;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }
    catsite-app::shadow core-toolbar {
      margin-top: 0px;
      background: #aa55bb;
      color: white;
    }
    catsite-app::shadow #tabs {
      width: 100%;
      margin: 0;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      text-transform: uppercase;
    }
    catsite-app::shadow core-pages {
      margin: 20px 40px;
    }
  </style>
  <script>
    Polymer({
      selected: 'status',
      switches: {},
      onStatus: function(e) {
        this.switches = _.sortBy(_.map(e.detail.response, function(val, key) {
          val.name = key
          return val
        }), 'idx')
      }
    })
  </script>
</polymer-element>
