<polymer-element name="updating-img" attributes="src">
  <template>
    <img id=img />
  </template>
  <script>
    Polymer({
      ready: function() {
        this.request()
      },
      request: function() {
        console.log('getting image', new Date)
        var img = this.$.img
        var next = this.request.bind(this)

        var xhr = new XMLHttpRequest
        xhr.open('GET', '/camera')
        xhr.responseType = 'blob'
        xhr.onload = function() {
          if (xhr.status !== 200) {
            console.log('failed to get image :(', xhr.status)
            setTimeout(next, 1000)
            return
          }

          var expires = new Date(xhr.getResponseHeader('Expires'))
          img.src = window.URL.createObjectURL(xhr.response)
          var nextRequestTime = expires.getTime() - Date.now()
          setTimeout(next, Math.max(nextRequestTime, 1000))
        }
        xhr.onerror = function() {
          console.log('xhr error :(')
          setTimeout(next, 5000)
        }
        xhr.send()
      }
    })
  </script>
</polymer-element>
